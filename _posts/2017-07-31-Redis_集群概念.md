---
layout: post
title: Redis 集群概念
date: 2017-07-31
tags: Redis    
---

### Redis集群

redis集群叫作redis-cluster,每个节点可以相互通信的,每个节点都是同等地位

### redis-cluster

redis-cluster把所有的物理节点映射到[0-16383]slot上,cluster 负责维护node<->slot<->value

Redis 集群中内置了 16384 个哈希槽，当需要在 Redis 集群中放置一个 key-value 时，redis 先对 key 使用 crc16 算法算出一个结果，然后把结果对 16384 求余数，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。

### redis-cluster投票:容错

当某一个节点向目标节点（这里假设目标节点为B节点）发送ping命令而没有得到响应则会对B节点产生怀疑,并将此怀疑广播给集群中的其他节点,其他节点都会向B节点发送ping命令检测B节点是否挂掉,只要集群中有半数以上认为B节点挂掉则就会认为B节点挂掉,若B节点没有备机则集群挂掉,因为槽不完整了，所以为了集群的高可用性,每个节点都应该有主备设施。

1. 投票过程是集群中所有master参与,如果半数以上master节点与master节点通信超过(cluster-node-timeout),认为当前master节点挂掉.
2. 什么时候整个集群不可用(cluster_state:fail)?
- a:如果集群任意master挂掉,且当前master没有slave（备机）.集群进入fail状态,也可以理解成集群的slot映射[0-16383]不完成时进入fail状态. ps : redis-3.0.0.rc1加入cluster-require-full-coverage参数,默认关闭,打开集群兼容部分失败.
- b:如果集群超过半数以上master挂掉，无论是否有slave集群进入fail状态.
    ps:当集群不可用时,所有对集群的操作做都不可用，收到((error) CLUSTERDOWN The cluster is down)错误