---
layout: post
title: Redis中的事务
date: 2017-10-02
tags: Redis    
---

### Redis中的事务

Redis支持简单的事务

<table>

<tr><th>操作</th><th>Mysql</th><th>Redis</th></tr>

<tr><td>开启</td><td>start transaction</td><td>muitl</td></tr>

<tr><td>语句</td><td>普通sql</td><td>普通命令</td></tr>

<tr><td>失败</td><td>rollback 回滚</td><td>discard 取消</td></tr>

<tr><td>成功</td><td>commit</td><td>exec</td></tr>

</table>

注: rollback与discard 的区别
如果已经成功执行了2条语句, 第3条语句出错.
Rollback后,前2条的语句影响消失.
Discard只是结束本次事务,前2条语句造成的影响仍然还在

注: 在mutil后面的语句中, 语句出错可能有2种情况

1. 语法就有问题, 

这种,exec时,报错, 所有语句得不到执行

2. 语法本身没错,但适用对象有问题. 比如 zadd 操作list对象

Exec之后,会执行正确的语句,并跳过有不适当的语句.

(如果zadd操作list这种事怎么避免? 这一点,由程序员负责)

### 思考

我正在买票
Ticket -1 , money -100
而票只有1张, 如果在我multi之后,和exec之前, 票被别人买了---即ticket变成0了.
我该如何观察这种情景,并不再提交

悲观的想法: 
世界充满危险,肯定有人和我抢, 给 ticket上锁, 只有我能操作. [悲观锁]

乐观的想法:
没有那么人和我抢,因此,我只需要注意,

- 有没有人更改ticket的值就可以了 [乐观锁]

**Redis的事务中,启用的是乐观锁,只负责监测key没有被改动**

### 具体场景

一个人正在买票, ticket-1, money-100, 而票只有一张, 如果在我multi之后, exec之前票被别人买走, 即ticket变为0了, 怎么办?

```
127.0.0.1:6379> set ticket 1    #加入只有1张票
OK
127.0.0.1:6379> set lisi 300    #lisi有300
OK
127.0.0.1:6379> set wang 300    #wang有300
OK
127.0.0.1:6379> 
127.0.0.1:6379> multi    #开启事务
OK
127.0.0.1:6379> decr ticket    #票数-1
QUEUED
127.0.0.1:6379> decrby lisi 100    #lisi准备买-100
QUEUED
127.0.0.1:6379> #此处还没有exec
```

假如就在exec之前票被别人买走，打开另一个终端

```
127.0.0.1:6379> decr ticket    #票-1
(integer) 0
127.0.0.1:6379> get ticket    #此时票数为0
"0"
127.0.0.1:6379> 
```

此时提交lisi

```
127.0.0.1:6379> exec
1) (integer) -1    #票变为-1
2) (integer) 200    #钱-100
127.0.0.1:6379> 
```

**因此上面的过程不合理,要解决上面的情况,要采用监视**

```
127.0.0.1:6379> set ticket 1    #票数为1
OK
127.0.0.1:6379> set lisi 200    #lisi钱是100
OK
127.0.0.1:6379> set wang 300    #wang是300
OK
127.0.0.1:6379> 
127.0.0.1:6379> watch ticket    #监控ticket有没有变动, 有变动的话则事务取消
OK
127.0.0.1:6379> multi    #开启事务
OK
127.0.0.1:6379> decr ticket    #ticket-1
QUEUED
127.0.0.1:6379> decrby lisi 100    #钱-100
QUEUED
127.0.0.1:6379>
```

在exec前票又被另一个人买走了

```
127.0.0.1:6379> decr ticket
(integer) 0
127.0.0.1:6379> get ticket
"0"
127.0.0.1:6379> 
```

此时票数为0, lisi提交

```
127.0.0.1:6379> 
127.0.0.1:6379> exec    #失败
(nil)
127.0.0.1:6379> 
127.0.0.1:6379> get lisi    #钱并没有减少
"200"
127.0.0.1:6379> 
```

